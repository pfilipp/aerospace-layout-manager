#!/bin/bash

# AeroSpace Layout from Dump-Tree
# Recreates a layout from aerospace dump-tree JSON output
#
# Usage:
#   ./aerospace-layout-from-dump.sh <workspace> <json_file>
#   ./aerospace-layout-from-dump.sh <workspace> < dump.json
#   aerospace dump-tree --workspace temp | ./aerospace-layout-from-dump.sh <workspace>

set -euo pipefail

# =============================================================================
# INITIALIZATION
# =============================================================================

# Determine script location and source library modules
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$(cd "$SCRIPT_DIR/../lib" && pwd)"

# Source all modules
source "$LIB_DIR/init.sh"

# =============================================================================
# MAIN
# =============================================================================

main() {
    check_dependencies

    local target_workspace=""
    local json_input=""

    # Parse arguments
    if [[ $# -lt 1 ]]; then
        echo "Usage: $0 <target_workspace> [json_file]"
        echo "       $0 <target_workspace> < dump.json"
        echo "       aerospace dump-tree --workspace X | $0 <target_workspace>"
        exit 1
    fi

    target_workspace="$1"

    if [[ $# -ge 2 ]]; then
        # JSON file provided as argument
        if [[ ! -f "$2" ]]; then
            error "File not found: $2"
            exit 1
        fi
        json_input=$(cat "$2")
    else
        # Read from stdin
        if [[ -t 0 ]]; then
            error "No JSON input provided. Pipe JSON or provide file path."
            exit 1
        fi
        json_input=$(cat)
    fi

    # Validate JSON
    if ! echo "$json_input" | jq empty 2>/dev/null; then
        error "Invalid JSON input"
        exit 1
    fi

    log "=========================================="
    log "AeroSpace Layout from Dump-Tree"
    log "=========================================="
    log "Target workspace: $target_workspace"
    log "Temp workspace: $TEMP_WORKSPACE"

    # Get root container
    local root_container
    root_container=$(get_root_container "$json_input")

    if [[ -z "$root_container" ]] || [[ "$root_container" == "null" ]]; then
        error "No root-container found in dump"
        exit 1
    fi

    local root_layout
    root_layout=$(echo "$root_container" | jq -r '.layout // "tiles"')
    log "Root layout: $root_layout"

    # Step 1: Clear ALL windows from target workspace to temp (MUST be first!)
    clear_workspace_to_temp "$target_workspace"

    # Step 2: Create window mapping (find all windows from dump)
    local mapping
    mapping=$(create_window_mapping "$root_container")

    local window_count
    window_count=$(echo "$mapping" | jq 'length')
    log "Found $window_count windows"

    # Step 3: Move dump windows to temp (in case they're on other workspaces)
    clear_dump_windows_to_temp "$mapping"

    # Step 4: Switch to target workspace
    log "Switching to workspace: $target_workspace"
    aerospace_workspace "$target_workspace"

    # Step 5: Move all windows to target workspace
    move_windows_to_workspace "$root_container" "$mapping" "$target_workspace"

    # Step 6: Flatten workspace and set root layout
    # This ensures all windows are at the same level before we start grouping
    log "Flattening workspace and setting root layout: $root_layout"
    aerospace_flatten_workspace_tree --workspace "$target_workspace"

    # Focus any window in the workspace and set root layout
    local any_window
    any_window=$(echo "$mapping" | jq -r 'to_entries[0].value // empty')
    if [[ -n "$any_window" ]]; then
        aerospace_focus --window-id "$any_window"
        aerospace_layout "$root_layout"
    fi

    # Step 7: Apply layout operations in two phases
    # Phase 1: Create all nested containers via joins
    # Pass root_layout so all joins use the correct spatial arrangement
    # Pass is_root=true for the root container so it doesn't try to join its children
    log "Phase 1: Creating nested containers..."
    apply_layout "$root_container" "$mapping" "$target_workspace" "$root_layout" "true"

    # Phase 2: Apply layouts to all containers
    # Done separately to prevent layout changes from affecting joins
    log "Phase 2: Applying container layouts..."
    apply_layouts "$root_container" "$mapping" "$target_workspace" "true"

    log "=========================================="
    log "Layout recreation complete!"
    log "=========================================="
}

main "$@"
